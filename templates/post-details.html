{% load static %}
{% load post_extras %}
<!DOCTYPE html>
<html lang="en">

  <head>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="https://fonts.googleapis.com/css?family=Roboto:100,100i,300,300i,400,400i,500,500i,700,700i,900,900i&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ" crossorigin="anonymous">

    <title>–î–µ—Ç–∞–ª–∏ –ø–æ—Å—Ç–∞</title>

    <!-- Bootstrap core CSS -->
    <link href="{% static 'vendor/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet">


    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="{% static 'assets/css/fontawesome.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="{% static 'assets/css/templatemo-stand-blog.css' %}">
    <link rel="stylesheet" href="{% static 'assets/css/owl.css' %}">
    
    <style>
      /* –°—Ç–∏–ª–∏ –¥–ª—è –∏–∫–æ–Ω–∫–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–æ–≤ */
      .view-icon i {
        margin-right: 4px;
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –ª–∞–π–∫–æ–≤ */
      .like-btn {
        border: 1px solid #dc3545;
        padding: 8px 16px;
        transition: all 0.3s ease;
      }
      
      .like-btn.liked {
        background: #dc3545;
        color: white;
      }
      
      .like-btn.not-liked {
        background: transparent;
        color: #dc3545;
      }
      
      .like-btn:hover {
        transform: scale(1.05);
      }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è —Ñ–æ—Ä–º –æ—Ç–≤–µ—Ç–∞ */
      .reply-form {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 1rem;
        margin-top: 0.5rem;
      }
      
      /* –û—Ç–ª–∞–¥–æ—á–Ω—ã–π —Å—Ç–∏–ª—å - –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞ */
      .reply-form.debug {
        display: block !important;
        border: 2px solid red;
      }
    </style>
    
<!--

TemplateMo 551 Stand Blog

https://templatemo.com/tm-551-stand-blog

-->
  </head>

  <body>

    {%include 'header.html'%}

    <section class="blog-posts grid-system">
      <div class="container">
        <div class="row">
          <div class="col-lg-8">
            <div class="all-blog-posts">
              <div class="row">
                <div class="col-lg-12">
                  <div class="blog-post">
                    <div class="blog-thumb">
                      <img src="{{media_url}}{{post.image}}" alt="post_image">
                    </div>
                    <div class="down-content">
                      <span>{{post.category}}</span>
                      <a><h4>{{post.postname}}</h4></a>
                      <ul class="post-info">
                        <li><a href="{% url 'profile' post.user.id %}">–ê–≤—Ç–æ—Ä: {{post.user.username}}</a></li>
                        <li><a href="#">{{post.time}}</a></li>
                        <li><a href="#">{{post|comment_count_text}}</a></li>
                        <li><a href="#"><span class="view-icon"><i class="fas fa-eye"></i><noscript>üëÅ</noscript></span> {{post.views|views_count_text}}</a></li>
                      </ul>
                      <div>{{post.content|safe}}</div>
                      <div class="post-options d-flex justify-content-between align-items-center mt-3">
                        <div class="d-flex align-items-center gap-3">
                          {% if user.is_authenticated %}
                          <form method="post" action="{% url 'toggle_like' post.id %}" class="like-form" data-post-id="{{post.id}}">
                            {% csrf_token %}
                            <button class="btn like-btn {% if post|is_liked_by:user %}liked{% else %}not-liked{% endif %}" type="submit"
                              title="{%if post|is_liked_by:user%}–£–±—Ä–∞—Ç—å –ª–∞–π–∫{%else%}–ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫{%endif%}">
                              <i class="fa fa-heart"></i> <span class="likes-count">{{post.likes}}</span>
                            </button>
                          </form>
                          {% else %}
                          <div class="btn" style="border: 1px solid #6c757d; background: transparent; color: #6c757d; cursor: not-allowed; padding: 8px 16px;">
                            <i class="fa fa-heart"></i> {{post.likes}}
                          </div>
                          {% endif %}
                          
                          <!-- –ö–Ω–æ–ø–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–∞ –∏ –∞–≤—Ç–æ—Ä–∞ -->
                          {% if user.is_authenticated and post|can_edit_post:user %}
                          <div class="d-flex gap-2">
                            <a href="{% url 'editpost' post.id %}" class="btn btn-sm btn-outline-primary" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç">
                              <i class="fa fa-edit"></i> –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                            </a>
                            <a href="{% url 'deletepost' post.id %}" class="btn btn-sm btn-outline-danger" 
                               onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø–æ—Å—Ç?')" title="–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç">
                              <i class="fa fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </a>
                          </div>
                          {% endif %}
                          
                        </div>
                        
                        <div class="small text-muted">
                          <span class="me-3"><span class="view-icon"><i></i><noscript>üëÅ</noscript></span> {{post.views|views_count_text}}</span>
                          <span><i class="fa fa-comment"></i> {{post|comment_count_text}}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="col-lg-12">
                  <div class="sidebar-item comments">
                    <div class="sidebar-heading">
                      <h2 class="text-dark-emphasis">{{post|comment_count}} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤</h2>
                    </div>
                    <div class="content">
                      <ul>
                        {% for comment in comments %}
                        {% if not comment.parent %}
                        <li style="display: block;" class="main-comment">
                          <div class="ps-3">
                            <h5>
                              {% if comment.is_deleted %}
                                <span class="text-muted">[–£–¥–∞–ª–µ–Ω–æ]</span>
                              {% else %}
                                {{comment.user}}
                              {% endif %}
                              <span class="small text-black-50 px-5 text-danger">{{comment.time}}</span>
                              {% if comment|can_delete_comment:user and not comment.is_deleted %}
                              <a href="{% url 'deletecomment' comment.id %}" class="small text-danger float-right fw-bold pt-1">–£–¥–∞–ª–∏—Ç—å</a>
                              {% endif %}
                            </h5>
                            <p>{{comment.get_display_content}}</p>
                            
                            {% if not comment.is_deleted %}
                            <div class="comment-actions d-flex gap-3 mb-2">
                              {% if user.is_authenticated %}
                              <!-- –õ–∞–π–∫ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
                              <form method="post" action="{% url 'toggle_comment_like' comment.id %}" class="comment-like-form d-inline" data-comment-id="{{comment.id}}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-link p-0 comment-like-btn" title="–õ–∞–π–∫">
                                  <i class="fa fa-heart {% if comment|is_liked_by_comment:user %}text-danger{% else %}text-muted{% endif %}"></i>
                                  <span class="comment-likes-count">{{comment.likes}}</span>
                                </button>
                              </form>
                              
                              <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–≤–µ—Ç–∞ -->
                              <button type="button" class="btn btn-sm btn-link p-0 text-primary reply-btn" data-comment-id="{{comment.id}}" onclick="toggleReplyForm({{comment.id}});">
                                <i class="fa fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å
                              </button>
                              {% endif %}
                            </div>
                            
                            <!-- –§–æ—Ä–º–∞ –æ—Ç–≤–µ—Ç–∞ (—Å–∫—Ä—ã—Ç–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é) -->
                            {% if user.is_authenticated %}
                            <div class="reply-form" id="reply-form-{{comment.id}}" style="display: none;">
                              <form method="post" action="{% url 'reply_comment' comment.id %}" class="mt-2">
                                {% csrf_token %}
                                <div class="row">
                                  <div class="col-10">
                                    <textarea name="content" rows="2" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç..." class="form-control" required></textarea>
                                  </div>
                                  <div class="col-2">
                                    <button type="submit" class="btn btn-primary btn-sm">–û—Ç–≤–µ—Ç–∏—Ç—å</button>
                                    <button type="button" class="btn btn-secondary btn-sm cancel-reply" onclick="$('#reply-form-{{comment.id}}').hide();">–û—Ç–º–µ–Ω–∞</button>
                                  </div>
                                </div>
                              </form>
                            </div>
                            {% endif %}
                            {% endif %}
                            
                            <!-- –û—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
                            {% for reply in comment.replies.all %}
                            <div class="reply ms-4 mt-2 border-start border-2 ps-3">
                              <h6>
                                {% if reply.is_deleted %}
                                  <span class="text-muted">[–£–¥–∞–ª–µ–Ω–æ]</span>
                                {% else %}
                                  {{reply.user}}
                                {% endif %}
                                <span class="small text-black-50 px-3 text-danger">{{reply.time}}</span>
                                {% if reply|can_delete_comment:user and not reply.is_deleted %}
                                <a href="{% url 'deletecomment' reply.id %}" class="small text-danger float-right fw-bold">–£–¥–∞–ª–∏—Ç—å</a>
                                {% endif %}
                              </h6>
                              <p class="small">{{reply.get_display_content}}</p>
                              
                              {% if not reply.is_deleted and user.is_authenticated %}
                              <div class="reply-actions">
                                <form method="post" action="{% url 'toggle_comment_like' reply.id %}" class="comment-like-form d-inline" data-comment-id="{{reply.id}}">
                                  {% csrf_token %}
                                  <button type="submit" class="btn btn-sm btn-link p-0 comment-like-btn" title="–õ–∞–π–∫">
                                    <i class="fa fa-heart {% if reply|is_liked_by_comment:user %}text-danger{% else %}text-muted{% endif %}"></i>
                                    <span class="comment-likes-count">{{reply.likes}}</span>
                                  </button>
                                </form>
                              </div>
                              {% endif %}
                            </div>
                            {% endfor %}
                          </div>
                        </li>
                        {% endif %}
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>
                {% if user.is_authenticated %}
                <div class="col-lg-12">
                  <div class="sidebar-item submit-comment">
                    <div class="sidebar-heading">
                      <h2>–û—Å—Ç–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</h2>
                    </div>
                    <div class="content">
                      <form id="comment" action="{% url 'savecomment' post.id %}" method="post">
                        {% csrf_token %}
                        <div class="row">
                          <div class="col-lg-12">
                            <fieldset>
                              <textarea name="message" rows="6" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π" class="text-lowercase" required></textarea>
                            </fieldset>
                          </div>
                          <div class="col-lg-12">
                            <fieldset>
                              <button type="submit" id="form-submit" class="main-button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                            </fieldset>
                          </div>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-lg-4">
            <div class="sidebar">
              <div class="row">
                <div class="col-lg-12">
                  <div class="sidebar-item recent-posts">
                    <div class="sidebar-heading">
                      <h2>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç—ã</h2>
                    </div>
                    <div class="content">
                      <ul>
                        {% for post in recent_posts|slice:"0:4" %}
                        <li>
                          <img src="{{media_url}}{{post.image}}" class="img-fluid" alt="">
                          <a href="post-details.html">
                            <a href="{% url 'post' post.id %}" class="text-decoration-none text-dark"><h5>{{post.postname}}</h5></a>
                          <span>{{post.time}}</span>
                        </a></li>
                        {% endfor %}
                      </ul>
                    </div>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>
    </section>


   {% include "footer.html" %}


    <!-- Bootstrap core JavaScript -->
    <script src="{% static 'vendor/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'vendor/bootstrap/js/bootstrap.bundle.min.js' %}"></script>


    <!-- Additional Scripts -->
    <script src="{% static 'assets/js/custom.js' %}"></script>
    <script src="{% static 'assets/js/owl.js' %}"></script>
    <script src="{% static 'assets/js/slick.js' %}"></script>
    <script src="{% static 'assets/js/isotope.js' %}"></script>
    <script src="{% static 'assets/js/accordions.js' %}"></script>

    <script>
      // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞
      function toggleReplyForm(commentId) {
          console.log('toggleReplyForm called with commentId:', commentId);
          
          // –°–∫—Ä—ã–≤–∞–µ–º –≤—Å–µ —Ñ–æ—Ä–º—ã –æ—Ç–≤–µ—Ç–∞
          $('.reply-form').hide();
          
          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—É—é —Ñ–æ—Ä–º—É
          var replyForm = $('#reply-form-' + commentId);
          console.log('Reply form element:', replyForm);
          
          if (replyForm.length > 0) {
              replyForm.show();
              console.log('Reply form shown');
              // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ–º –ø–æ–ª–µ
              replyForm.find('textarea').focus();
          } else {
              console.log('Reply form not found');
          }
      }
    </script>

    <script language = "text/Javascript">
      cleared[0] = cleared[1] = cleared[2] = 0; //set a cleared flag for each field
      function clearField(t){                   //declaring the array outside of the
      if(! cleared[t.id]){                      // function makes it static and global
          cleared[t.id] = 1;  // you could use true and false, but that's more typing
          t.value='';         // with more chance of typos
          t.style.color='#fff';
          }
      }
      
      // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      function showNotification(message, type = 'info') {
          // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          $('.notification').remove();
          
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
          var bgClass = type === 'success' ? 'alert-success' : 'alert-info';
          
          // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
          var notification = $('<div class="alert ' + bgClass + ' alert-dismissible fade show notification" role="alert" style="position: fixed; top: 20px; right: 20px; z-index: 9999; min-width: 300px;">' +
              message + 
              '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>' +
              '</div>');
          
          // –î–æ–±–∞–≤–ª—è–µ–º –≤ body
          $('body').append(notification);
          
          // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–¥–∞–ª—è–µ–º —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(function() {
              notification.fadeOut();
          }, 3000);
      }
      
      // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –æ—Ç–≤–µ—Ç–∞
      $(document).ready(function() {
          console.log('JavaScript loaded');
          console.log('Reply buttons found:', $('.reply-btn').length);
          
          // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–º–µ–Ω—ã
          $(document).on('click', '.cancel-reply', function() {
              $(this).closest('.reply-form').hide();
          });
          
          // AJAX –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –ª–∞–π–∫–æ–≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
          $(document).on('submit', '.comment-like-form', function(e) {
              e.preventDefault();
              
              var form = $(this);
              var commentId = form.data('comment-id');
              var url = form.attr('action');
              var csrfToken = form.find('[name=csrfmiddlewaretoken]').val();
              
              $.ajax({
                  url: url,
                  type: 'POST',
                  data: {
                      'csrfmiddlewaretoken': csrfToken
                  },
                  success: function(response) {
                      if (response.success) {
                          var heartIcon = form.find('.fa-heart');
                          var likesCount = form.find('.comment-likes-count');
                          
                          // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –ª–∞–π–∫–æ–≤
                          likesCount.text(response.likes_count);
                          
                          // –ú–µ–Ω—è–µ–º —Ü–≤–µ—Ç —Å–µ—Ä–¥–µ—á–∫–∞
                          if (response.liked) {
                              heartIcon.removeClass('text-muted').addClass('text-danger');
                          } else {
                              heartIcon.removeClass('text-danger').addClass('text-muted');
                          }
                      }
                  },
                  error: function() {
                      showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ª–∞–π–∫–∞', 'error');
                  }
              });
          });
      });
      
      // AJAX –¥–ª—è –ª–∞–π–∫–æ–≤
      $(document).ready(function() {
          $('.like-form').on('submit', function(e) {
              e.preventDefault();
              
              var form = $(this);
              var postId = form.data('post-id');
              var button = form.find('.like-btn');
              var counter = button.find('.likes-count');
              
              // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
              button.prop('disabled', true);
              
              $.ajax({
                  url: form.attr('action'),
                  type: 'POST',
                  data: form.serialize(),
                  headers: {
                      'X-Requested-With': 'XMLHttpRequest',
                  },
                  success: function(response) {
                      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                      counter.text(response.likes_count);
                      
                      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∏–ª—å –∫–Ω–æ–ø–∫–∏
                      if (response.is_liked) {
                          button.css({
                              'background': '#dc3545',
                              'color': 'white'
                          });
                          button.attr('title', '–£–±—Ä–∞—Ç—å –ª–∞–π–∫');
                      } else {
                          button.css({
                              'background': 'transparent',
                              'color': '#dc3545'
                          });
                          button.attr('title', '–ü–æ—Å—Ç–∞–≤–∏—Ç—å –ª–∞–π–∫');
                      }
                      
                      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                      showNotification(response.message, response.is_liked ? 'success' : 'info');
                  },
                  error: function() {
                      alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –ª–∞–π–∫–∞');
                  },
                  complete: function() {
                      // –í–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –æ–±—Ä–∞—Ç–Ω–æ
                      button.prop('disabled', false);
                  }
              });
          });
      });
    </script>


  </body>

</html>
